$-------------------------------------- L'ACTIONNEUR ------------------domain actionActionneur : 0 .. 4 ;$ 0 : repli!, 1 : arret-act?, 2: V1-act?, 3 : V2-act?, 4 : TAUdomain etatActionneur : 0 .. 3 ;$ 0 : arret, 1 : vitesse1, 2 : vitesse2, 3 : erreurdisplay #actionneur [s:etatActionneur, a:actionActionneur, d:etatActionneur] :=   ({s=0} & {a=2} & {d=1}) |  ({s=0} & {a=1} & {d=3}) |  ({s=0} & {a=3} & {d=3}) |  ({s=1} & {a=1} & {d=0}) |  ({s=1} & {a=2} & {d=3}) |  ({s=1} & {a=0} & {d=1}) | $ repli  ({s=1} & {a=3} & {d=2}) |  ({s=2} & {a=0} & {d=2}) |  ({s=2} & {a=2} & {d=1}) |  ({s=2} & {a=1} & {d=3}) ;$-------------------------------------- MODES DE MARCHE ----------domain actionModeDeMarche : 0 .. 5 ;$--- Mode de marche "intermittent"$ 0 : V1-act!, 1 : repli?, 2 : arret-act!, 3 : attente 5s, 4 : TAU, 5 : V2-act!domain etatModeDeMarche : 0 .. 6 ;$---- Mode de marche "arret"$ 0 : arret$--- Mode de marche "intermittent"$ 1 : arreté, 2 : vitesse V1, 3 : repli reçu, 4 : en attente$--- Mode de marche "vitesse 1"$ 5 : vitesse V1$--- Mode de marche "vitesse 2"$ 6 : vitesse V2$--- Mode arrêt#etatsModeArret [q : etatModeDeMarche] := {q = 0} ;#modeArret [s:etatModeDeMarche, a:actionModeDeMarche, d:etatModeDeMarche] := false ;$--- Mode intermittent#etatsModeIntermittent [q : etatModeDeMarche] := {q >= 1} & {q <= 4} ;display #modeIntermittent [s:etatModeDeMarche, a:actionModeDeMarche, d:etatModeDeMarche] :=  ({s=1} & {a=0} & {d=2}) |  ({s=2} & {a=1} & {d=3}) |  ({s=3} & {a=2} & {d=4}) |  ({s=4} & {a=3} & {d=1}) ;  $--- Mode vitesse 1#etatsModeVitesse1 [q : etatModeDeMarche] := {q = 5} ;#modeVitesse1 [s:etatModeDeMarche, a:actionModeDeMarche, d:etatModeDeMarche] := {s=5} & {a=1} & {d=5} ;$--- Mode vitesse 2#etatsModeVitesse2 [q : etatModeDeMarche] := {q = 6} ;#modeVitesse2 [s:etatModeDeMarche, a:actionModeDeMarche, d:etatModeDeMarche] := {s=6} & {a=1} & {d=6} ;$--------- Vérification de la compatibilité du mode de marche "intermittent"domain actionActMode : record  a : actionActionneur ;  m : actionModeDeMarche ;end record ;domain etatActMode : record  a : etatActionneur ;  m : etatModeDeMarche ;end record ;$--- Produit partiel commun à tous les modes#produitPartiel [s:etatActMode, a:actionActMode, d:etatActMode] :=  (#actionneur [s.a, a.a, d.a] | ({s.a = d.a} & {a.a = 4})) &$--- la compatibilité des états sources  (    ({s.a = 0} & {s.m = 1}) | $ arret    ({s.a = 0} & {s.m = 4}) | $ arret    ({s.a = 1} & {s.m = 2}) | $ vitesse V1    ({s.a = 1} & {s.m = 3})  $ vitesse V1  ) &$--- la compatibilité des états destinations  (    ({d.a = 0} & {d.m = 1}) | $ arret    ({d.a = 0} & {d.m = 4}) | $ arret    ({d.a = 1} & {d.m = 2}) | $ vitesse V1    ({d.a = 1} & {d.m = 3})  $ vitesse V1  ) &$--- la synchro  (   ({a.a = 0} & {a.m = 1}) | $ repli       ({a.a = 1} & {a.m = 2}) | $ arret-act       ({a.a = 2} & {a.m = 0}) | $ V1-act    $   ({a.a = 3} & {a.m = }) | $ V2-act       ({a.a = 4} & {a.m = 3})   $ attente 5 s (synchro avec TAU)   ) ;$--------- Vérification de la compatibilité du mode de marche "intermittent"display #superviseurModeIntermittent [s:etatActMode, a:actionActMode, d:etatActMode] :=  #produitPartiel [s, a, d] & (#modeIntermittent [s.m, a.m, d.m] | ({s.m = d.m} & {a.m = 4})) ;#etatsModeSuperviseur [q:etatActMode] := ? a:actionActMode, p:etatActMode  (#superviseurModeIntermittent [q, a, p] | #superviseurModeIntermittent [p, a, q]  ) ;$---- Calcul de la plus grande bisimulation#bisimulationModeIntermittent [q1:etatModeDeMarche, q2:etatActMode] -=  (! am:actionModeDeMarche, q1d:etatModeDeMarche    (#modeIntermittent [q1, am, q1d] -> ?q2d:etatActMode, a:actionActMode      (#superviseurModeIntermittent [q2, a, q2d] & #bisimulationModeIntermittent [q1d, q2d] & {a.m = am}      )    )  ) &  (! a:actionActMode, q2d:etatActMode    (#superviseurModeIntermittent [q2, a, q2d] -> ?q1d:etatModeDeMarche      (#modeIntermittent [q1, a.m, q1d] & #bisimulationModeIntermittent [q1d, q2d]      )    )  )  ;$---- Vérification de l'équivalence#modeIntermittentCorrect :=   !q1:etatModeDeMarche (#etatsModeIntermittent [q1] -> ?q2:etatActMode (#etatsModeSuperviseur [q2] & #bisimulationModeIntermittent [q1, q2])) &   !q2:etatActMode (#etatsModeSuperviseur [q2] -> ?q1:etatModeDeMarche (#etatsModeIntermittent [q1] & #bisimulationModeIntermittent [q1, q2])) ;$-------------------------------------- LE COMMODO -------------------domain actionCommodo : 0 .. 4 ;$ 0 : arret-commodo!, 1 : inter-commodo!, 2: V1-commodo!, 3 : V2-commodo!, 4 : TAUdomain etatCommodo : 0 .. 3 ;$ 0 : arret, 1 : intermittent, 2 : Vitesse1, 3 : vitesse 2display #commodo [s:etatCommodo, a:actionCommodo, d:etatCommodo] :=   ({s=0} & {a=1} & {s=1}) |  ({s=1} & {a=2} & {d=2}) |  ({s=1} & {a=0} & {d=0}) |  ({s=2} & {a=3} & {d=3}) |  ({s=2} & {a=1} & {d=1}) |  ({s=3} & {a=2} & {d=2}) ;$-------------------------------------- CONSTRUCTION DU SUPERVISEUR DE MODES -----------------------domain actionChangementDeMode : 0 .. 4 ;$--- action de changement de mode$ 0 : arret-commodo?, 1 : inter-commodo?, 2 : V1-commodo?, 3 : V2-commodo?, 4 : TAUdomain etat : record  a : etatActionneur ;  m : etatModeDeMarche ;  c : etatCommodo ;end record ;domain action : record  a : actionActionneur ;  m : actionModeDeMarche ;  t : actionChangementDeMode ;  c : actionCommodo ;end record ;$-------------------------- La synchronisation -----------------------$--- La synchronisation entre l'actionneur et le superviseur#actionsSynchroActionneurSuperviseur [act : action] :=  (({act.a = 0} & {act.m = 1}) $ repli?, repli!   |   ({act.a = 1} & {act.m = 2}) $ arret-act?, arret-act!   |   ({act.a = 2} & {act.m = 0}) $ V1-act?, V1-act!   |   ({act.a = 3} & {act.m = 5}) $ V2-act?, V2-act!   |   ({act.a = 4} & {act.m = 3}) $ TAU, attente 5s$   |$   ({act.a = 4} & {act.m = 4}) $ TAU, TAU  )  ;$--- Les actions de changement de modes entre superviseur et commodo, sans commande sur l'actionneur#actionsChgt1 [act : action] :=  ({act.a = 4} & {act.m = 4} & {act.t = 0} & {act.c = 0}) $ TAU, TAU, arret-commodo?, arret-commodo!  |  ({act.a = 4} & {act.m = 4} & {act.t = 1} & {act.c = 1}) $ TAU, TAU, inter-commodo?, inter-commodo!  |  ({act.a = 4} & {act.m = 4} & {act.t = 2} & {act.c = 2}) $ TAU, TAU, V1-commodo?, V1-commodo!  |  ({act.a = 4} & {act.m = 4} & {act.t = 3} & {act.c = 3}) $ TAU, TAU, V2-commodo?, V2-commodo!  ;$--- Les actions de changement de modes entre superviseur et commodo avec commande de l'actionneur #actionsChgt2 [act : action] :=  (({act.a = 0} & {act.m = 1}) $ repli?, repli!   |   ({act.a = 1} & {act.m = 2}) $ arret-act?, arret-act!   |   ({act.a = 2} & {act.m = 0}) $ V1-act?, V1-act!   |   ({act.a = 3} & {act.m = 5}) $ V2-act?, V2-act!  )  &  (   ({act.t = 0} & {act.c = 0}) $ arret-commodo?, arret-commodo!   |   ({act.t = 1} & {act.c = 1}) $ inter-commodo?, inter-commodo!   |   ({act.t = 2} & {act.c = 2}) $ V1-commodo?, V1-commodo!   |   ({act.t = 3} & {act.c = 3}) $ V2-commodo?, V2-commodo!  )  ;#toutesActionsChgtMode [act : action] := #actionsChgt1 [act] | #actionsChgt2 [act] ;$------------ Ensemble des transitions possibles $--- Toutes transitions, synchro actionneur/superviseur, sans compatibilité d'états, sans transition de mode#tout [s:etat, a:action, d:etat] :=  (#modeArret [s.m, a.m, d.m]    | #modeIntermittent [s.m, a.m, d.m]    | #modeVitesse1 [s.m, a.m, d.m]    | #modeVitesse2 [s.m, a.m, d.m]    | ({s.m = d.m} & {a.m = 4})  )  & (#actionneur [s.a, a.a, d.a] | ({s.a = d.a} & {a.a = 4}))  & #actionsSynchroActionneurSuperviseur [a]  & {s.c = d.c} $ le commodo ne change pas d'état  & {a.t = 4} $ pas de changement de mode  & {a.c = 4} $ le commodo effectue TAU  ;#etatsTout [q : etat] := ?a:action, d:etat (#tout [q, a, d] | #tout [d, a, q]) ;$--- Les transitions de changement de mode#transChgmtMode [s:etat, a:action, d:etat] :=  (  $--- Transition arret -> intermittent    ({s.c = 0} & {a.c = 1} & #etatsModeArret [s.m] & #toutesActionsChgtMode [a] & #etatsModeIntermittent [d.m] & {d.c = 1})    |  $--- Transition arret -> vitesse 1$    ({s.c = 0} & {a.c = 2} & #etatsModeArret [s.m] & #toutesActionsChgtMode [a] & #etatsModeVitesse1 [d.m] & {d.c = 2})$    |  $--- Transition arret -> vitesse 2$    ({s.c = 0} & {a.c = 3} & #etatsModeArret [s.m] & #toutesActionsChgtMode [a] & #etatsModeVitesse2 [d.m] & {d.c = 3})$    |  $--- Transition intermittent -> arret    ({s.c = 1} & {a.c = 0} & #etatsModeIntermittent [s.m] & #toutesActionsChgtMode [a] & #etatsModeArret [d.m])    |  $--- Transition intermittent -> vitesse 1    ({s.c = 1} & {a.c = 2}  & #etatsModeIntermittent [s.m] & #toutesActionsChgtMode [a] & #etatsModeVitesse1 [d.m] & {d.c = 2})    |  $--- Transition intermittent -> vitesse 2$    ({s.c = 1} & {a.c = 3} & #etatsModeIntermittent [s.m] & #toutesActionsChgtMode [a] & #etatsModeVitesse2 [d.m] & {d.c = 3})$    |  $--- Transition vitesse 1 -> arret$    ({s.c = 2} & {a.c = 0} & #etatsModeVitesse1 [s.m] & #toutesActionsChgtMode [a] & #etatsModeArret [d.m] & {d.c = 0})$    |  $--- Transition vitesse 1 -> intermittent    ({s.c = 2} & {a.c = 1} & #etatsModeVitesse1 [s.m] & #toutesActionsChgtMode [a] & #etatsModeIntermittent [d.m] & {d.c = 1})    |  $--- Transition vitesse 1 -> vitesse 2    ({s.c = 2} & {a.c = 3} & #etatsModeVitesse1 [s.m] & #toutesActionsChgtMode [a] & #etatsModeVitesse2 [d.m] & {d.c = 3})    |  $--- Transition vitesse 2 -> arret$    ({s.c = 3} & {a.c = 0} & #etatsModeVitesse2 [s.m] & #toutesActionsChgtMode [a] & #etatsModeArret [d.m] & {d.c = 0})$    |  $--- Transition vitesse 2 -> intermittent$    ({s.c = 3} & {a.c = 1} & #etatsModeVitesse2 [s.m] & #toutesActionsChgtMode [a] & #etatsModeIntermittent [d.m] & {d.c = 1})$    |  $--- Transition vitesse 2 -> vitesse 1    ({s.c = 3} & {a.c = 2} & #etatsModeVitesse2 [s.m] & #toutesActionsChgtMode [a] & #etatsModeVitesse1 [d.m] & {d.c = 2})  )  & #etatsTout [s]  & #etatsTout [d]  ;$--- On rajoute les transitions de changement de mode#toutAvecChgtMode [s:etat, a:action, d:etat] := #tout [s, a, d] | #transChgmtMode [s, a, d] ;  $--- Toutes transitions, sans synchro, avec compatibilité d'états, avec changements de modes#toutAvecConcordanceEtat [s:etat, a:action, d:etat] :=  #toutAvecChgtMode [s, a, d]$--- la compatibilité des états sources  &  (    ({s.a = 0} & {s.m = 0}) | $ arret (mode arret)    ({s.a = 0} & {s.m = 1}) | $ arret (mode intermittent)    ({s.a = 0} & {s.m = 4}) | $ arret (mode intermittent)    ({s.a = 1} & {s.m = 2}) | $ vitesse V1 (mode intermittent)    ({s.a = 1} & {s.m = 3}) | $ vitesse V1 (mode intermittent)    ({s.a = 1} & {s.m = 5}) | $ vitesse V1 (mode vitesse 1)    ({s.a = 2} & {s.m = 6})   $ vitesse V2 (mode vitesse 2)  )$--- la compatibilité des états destinations  &  (    ({d.a = 0} & {d.m = 0}) | $ arret (mode arret)    ({d.a = 0} & {d.m = 1}) | $ arret (mode intermittent)    ({d.a = 0} & {d.m = 4}) | $ arret (mode intermittent)    ({d.a = 1} & {d.m = 2}) | $ vitesse V1 (mode intermittent)    ({d.a = 1} & {d.m = 3}) | $ vitesse V1 (mode intermittent)    ({d.a = 1} & {d.m = 5}) | $ vitesse V1 (mode vitesse 1)    ({d.a = 2} & {d.m = 6})   $ vitesse V2 (mode vitesse 2)  ) ;$--- Calcul de la partie accessible#accessible [q:etat] +=  ({q.a=0} & {q.c=0} & {q.m = 0}) $ etat initial  |  (?s:etat, a:action (#accessible [s] & #toutAvecConcordanceEtat [s, a, q]))  ;#final [s:etat, a:action, d:etat] := #toutAvecConcordanceEtat [s, a, d] & #accessible [s] ;end